<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>WorkflowBusiness.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">coverage</a> &gt; <a href="../index.html" class="el_bundle">vip-application</a> &gt; <a href="index.source.html" class="el_package">fr.insalyon.creatis.vip.application.server.business</a> &gt; <span class="el_source">WorkflowBusiness.java</span></div><h1>WorkflowBusiness.java</h1><pre class="source lang-java linenums">/*
 * Copyright and authors: see LICENSE.txt in base repository.
 *
 * This software is a web portal for pipeline execution on distributed systems.
 *
 * This software is governed by the CeCILL-B license under French law and
 * abiding by the rules of distribution of free software.  You can  use,
 * modify and/ or redistribute the software under the terms of the CeCILL-B
 * license as circulated by CEA, CNRS and INRIA at the following URL
 * &quot;http://www.cecill.info&quot;.
 *
 * As a counterpart to the access to the source code and  rights to copy,
 * modify and redistribute granted by the license, users are provided only
 * with a limited warranty  and the software's author,  the holder of the
 * economic rights,  and the successive licensors  have only  limited
 * liability.
 *
 * In this respect, the user's attention is drawn to the risks associated
 * with loading,  using,  modifying and/or developing or reproducing the
 * software by the user in light of its specific status of free software,
 * that may mean  that it is complicated to manipulate,  and  that  also
 * therefore means  that it is reserved for developers  and  experienced
 * professionals having in-depth computer knowledge. Users are therefore
 * encouraged to load and test the software's suitability as regards their
 * requirements in conditions enabling the security of their systems and/or
 * data to be ensured and,  more generally, to use and operate it in the
 * same conditions as regards security.
 *
 * The fact that you are presently reading this means that you have had
 * knowledge of the CeCILL-B license and that you accept its terms.
 */
package fr.insalyon.creatis.vip.application.server.business;

import fr.insalyon.creatis.grida.client.GRIDAClient;
import fr.insalyon.creatis.grida.client.GRIDAClientException;
import fr.insalyon.creatis.grida.client.GRIDAPoolClient;
import fr.insalyon.creatis.moteur.plugins.workflowsdb.bean.*;
import fr.insalyon.creatis.moteur.plugins.workflowsdb.dao.*;
import fr.insalyon.creatis.vip.application.client.ApplicationConstants;
import fr.insalyon.creatis.vip.application.client.bean.*;
import fr.insalyon.creatis.vip.application.client.view.monitor.SimulationStatus;
import fr.insalyon.creatis.vip.application.client.view.monitor.progress.ProcessorStatus;
import fr.insalyon.creatis.vip.application.server.business.simulation.ParameterSweep;
import fr.insalyon.creatis.vip.application.server.business.simulation.parser.GwendiaParser;
import fr.insalyon.creatis.vip.application.server.business.simulation.parser.InputM2Parser;
import fr.insalyon.creatis.vip.application.server.business.simulation.parser.ScuflParser;
import fr.insalyon.creatis.vip.application.server.dao.ApplicationDAO;
import fr.insalyon.creatis.vip.application.server.dao.EngineDAO;
import fr.insalyon.creatis.vip.application.server.dao.SimulationStatsDAO;
import fr.insalyon.creatis.vip.core.client.bean.User;
import fr.insalyon.creatis.vip.core.client.view.CoreConstants;
import fr.insalyon.creatis.vip.core.server.business.BusinessException;
import fr.insalyon.creatis.vip.core.server.business.EmailBusiness;
import fr.insalyon.creatis.vip.core.server.business.Server;
import fr.insalyon.creatis.vip.core.server.dao.DAOException;
import fr.insalyon.creatis.vip.core.server.dao.UsersGroupsDAO;
import fr.insalyon.creatis.vip.datamanager.client.view.DataManagerException;
import fr.insalyon.creatis.vip.datamanager.server.DataManagerUtil;
import fr.insalyon.creatis.vip.datamanager.server.business.DataManagerBusiness;
import fr.insalyon.creatis.vip.datamanager.server.business.ExternalPlatformBusiness;
import fr.insalyon.creatis.vip.datamanager.server.business.LfcPathsBusiness;
import org.apache.commons.io.FileUtils;
import org.apache.commons.io.FilenameUtils;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Lookup;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import org.xml.sax.SAXException;

import java.io.File;
import java.io.IOException;
import java.util.*;

import static fr.insalyon.creatis.vip.application.client.view.ApplicationException.ApplicationError.*;

/**
 *
 * @author Rafael Ferreira da Silva
 */
@Service
@Transactional
public class WorkflowBusiness {

<span class="fc" id="L86">    private final Logger logger = LoggerFactory.getLogger(getClass());</span>

    private Server server;
    private SimulationStatsDAO simulationStatsDAO;
    private WorkflowDAO workflowDAO;
    private ProcessorDAO processorDAO;
    private OutputDAO outputDAO;
    private InputDAO inputDAO;
    private StatsDAO statsDAO;
    private EngineDAO engineDAO;
    private ApplicationDAO applicationDAO;
    private UsersGroupsDAO usersGroupsDAO;
    private EngineBusiness engineBusiness;
    private DataManagerBusiness dataManagerBusiness;
    private EmailBusiness emailBusiness;
    private LfcPathsBusiness lfcPathsBusiness;
    private GRIDAPoolClient gridaPoolClient;
    private GRIDAClient gridaClient;
    private ExternalPlatformBusiness externalPlatformBusiness;

    @Autowired
    public WorkflowBusiness(
            Server server, SimulationStatsDAO simulationStatsDAO,
            WorkflowDAO workflowDAO, ProcessorDAO processorDAO,
            OutputDAO outputDAO, InputDAO inputDAO, StatsDAO statsDAO,
            EngineDAO engineDAO, ApplicationDAO applicationDAO,
            UsersGroupsDAO usersGroupsDAO, EngineBusiness engineBusiness,
            DataManagerBusiness dataManagerBusiness, EmailBusiness emailBusiness,
            LfcPathsBusiness lfcPathsBusiness, GRIDAPoolClient gridaPoolClient,
<span class="fc" id="L115">            GRIDAClient gridaClient, ExternalPlatformBusiness externalPlatformBusiness) {</span>
<span class="fc" id="L116">        this.server = server;</span>
<span class="fc" id="L117">        this.simulationStatsDAO = simulationStatsDAO;</span>
<span class="fc" id="L118">        this.workflowDAO = workflowDAO;</span>
<span class="fc" id="L119">        this.processorDAO = processorDAO;</span>
<span class="fc" id="L120">        this.outputDAO = outputDAO;</span>
<span class="fc" id="L121">        this.inputDAO = inputDAO;</span>
<span class="fc" id="L122">        this.statsDAO = statsDAO;</span>
<span class="fc" id="L123">        this.engineDAO = engineDAO;</span>
<span class="fc" id="L124">        this.applicationDAO = applicationDAO;</span>
<span class="fc" id="L125">        this.usersGroupsDAO = usersGroupsDAO;</span>
<span class="fc" id="L126">        this.engineBusiness = engineBusiness;</span>
<span class="fc" id="L127">        this.dataManagerBusiness = dataManagerBusiness;</span>
<span class="fc" id="L128">        this.emailBusiness = emailBusiness;</span>
<span class="fc" id="L129">        this.lfcPathsBusiness = lfcPathsBusiness;</span>
<span class="fc" id="L130">        this.gridaPoolClient = gridaPoolClient;</span>
<span class="fc" id="L131">        this.gridaClient = gridaClient;</span>
<span class="fc" id="L132">        this.externalPlatformBusiness = externalPlatformBusiness;</span>
<span class="fc" id="L133">    }</span>

    /*
    The 4 next dependencies cannot be injected by spring in a classic way as
    they cannot be singleton (spring default scope). A new instance must be
    created at each use and so we use the prototype scope with lookup methods
    to inject them.
    They need to be injected by spring (and not created with &quot;new&quot;) so spring
    can handle their own dependencies.
     */
    @Lookup
    protected WorkflowExecutionBusiness getWorkflowExecutionBusiness(String endpoint) {
        // will be generated by spring to return a new instance each time
<span class="nc" id="L146">        return null;</span>
    }

    @Lookup
    protected GwendiaParser getGwendiaParser() {
        // will be generated by spring to return a new instance each time
<span class="nc" id="L152">        return null;</span>
    }

    @Lookup
    protected ScuflParser getScuflParser() {
        // will be generated by spring to return a new instance each time
<span class="nc" id="L158">        return null;</span>
    }

    @Lookup
    protected InputM2Parser getInputM2Parser(String currentUserFolder) {
        // will be generated by spring to return a new instance each time
<span class="nc" id="L164">        return null;</span>
    }

    private Engine selectEngine(String applicationClass)
            throws BusinessException {
<span class="nc" id="L169">        long min = Integer.MAX_VALUE;</span>
<span class="nc" id="L170">        Engine engineBean = null;</span>
        try {
<span class="nc" id="L172">            List&lt;Engine&gt; availableEngines = engineDAO.getByClass(applicationClass);</span>
<span class="nc bnc" id="L173" title="All 2 branches missed.">            for (Engine engine : availableEngines) {</span>
<span class="nc" id="L174">                long runningWorkflows = workflowDAO.getNumberOfRunningPerEngine(engine.getEndpoint());</span>
<span class="nc bnc" id="L175" title="All 2 branches missed.">                if (runningWorkflows &lt; min) {</span>
<span class="nc" id="L176">                    min = runningWorkflows;</span>
<span class="nc" id="L177">                    engineBean = engine;</span>
                }
<span class="nc" id="L179">            }</span>
<span class="nc" id="L180">        } catch (DAOException ex) {</span>
<span class="nc" id="L181">            throw new BusinessException(ex);</span>
<span class="nc" id="L182">        } catch (WorkflowsDBDAOException ex) {</span>
<span class="nc" id="L183">            logger.error(&quot;Error finding an engine for {}&quot;, applicationClass, ex);</span>
<span class="nc" id="L184">        }</span>
<span class="nc bnc" id="L185" title="All 4 branches missed.">        if (engineBean == null || engineBean.getEndpoint().isEmpty()) {</span>
<span class="nc" id="L186">            logger.error(&quot;No available engines for class {}&quot;, applicationClass);</span>
<span class="nc" id="L187">            throw new BusinessException(&quot;No available engines for class &quot; + applicationClass);</span>
        } else {
<span class="nc" id="L189">            return engineBean;</span>
        }
    }

    private Engine selectRandomEngine(String applicationClass)
            throws BusinessException {
<span class="nc" id="L195">        Engine engineBean = null;</span>
        try {
<span class="nc" id="L197">            List&lt;Engine&gt; availableEngines = engineDAO.getByClass(applicationClass);</span>
<span class="nc" id="L198">            Random randomizer = new Random();</span>
<span class="nc" id="L199">            engineBean = availableEngines.get(randomizer.nextInt(availableEngines.size()));</span>

<span class="nc" id="L201">        } catch (DAOException ex) {</span>
<span class="nc" id="L202">            throw new BusinessException(ex);</span>
<span class="nc" id="L203">        }</span>
<span class="nc bnc" id="L204" title="All 4 branches missed.">        if (engineBean == null || engineBean.getEndpoint().isEmpty()) {</span>
<span class="nc" id="L205">            logger.error(&quot;No available engines for class {}&quot;, applicationClass);</span>
<span class="nc" id="L206">            throw new BusinessException(&quot;No available engines for class &quot; + applicationClass);</span>
        }

<span class="nc" id="L209">        return engineBean;</span>
    }

    public synchronized String launch(
            User user, List&lt;String&gt; groups, Map&lt;String, String&gt; parametersMap,
            String applicationName, String applicationVersion,
            String applicationClass, String simulationName)
            throws BusinessException {

        try {
<span class="nc" id="L219">            long runningWorkflows = workflowDAO.getNumberOfRunning(user.getFullName());</span>
<span class="nc" id="L220">            long runningSimulations=workflowDAO.getRunning().size();</span>
<span class="nc bnc" id="L221" title="All 2 branches missed.">            if(runningSimulations &gt;= server.getMaxPlatformRunningSimulations()){</span>
<span class="nc" id="L222">                logger.warn(&quot;Unable to launch execution '{}': max number of&quot;</span>
                        + &quot; running workflows reached in the platform : {}&quot;,
<span class="nc" id="L224">                        simulationName, runningSimulations);</span>
<span class="nc" id="L225">                throw new BusinessException(PLATFORM_MAX_EXECS);</span>
            }
<span class="nc bnc" id="L227" title="All 2 branches missed.">            if (runningWorkflows &gt;= user.getMaxRunningSimulations()) {</span>

<span class="nc" id="L229">                logger.warn(&quot;Unable to launch execution '{}': max number of &quot;</span>
                        + &quot;running workflows reached ({}/{}) for user '{}'.&quot;,
<span class="nc" id="L231">                        simulationName, runningWorkflows,</span>
<span class="nc" id="L232">                        user.getMaxRunningSimulations(), user);</span>
<span class="nc" id="L233">                throw new BusinessException(USER_MAX_EXECS, runningWorkflows);</span>
            }

<span class="nc" id="L236">            List&lt;ParameterSweep&gt; parameters = new ArrayList&lt;ParameterSweep&gt;();</span>
<span class="nc bnc" id="L237" title="All 2 branches missed.">            for (String name : parametersMap.keySet()) {</span>

<span class="nc" id="L239">                ParameterSweep ps = new ParameterSweep(name);</span>
<span class="nc" id="L240">                String valuesStr = parametersMap.get(name);</span>
<span class="nc bnc" id="L241" title="All 2 branches missed.">                if (valuesStr.contains(ApplicationConstants.SEPARATOR_INPUT)) {</span>

<span class="nc" id="L243">                    String[] values = valuesStr.split(ApplicationConstants.SEPARATOR_INPUT);</span>
<span class="nc bnc" id="L244" title="All 2 branches missed.">                    if (values.length != 3) {</span>
<span class="nc" id="L245">                        throw new fr.insalyon.creatis.vip.core.server.business.BusinessException(&quot;Error in range.&quot;);</span>
                    }

<span class="nc" id="L248">                    Double start = Double.parseDouble(values[0]);</span>
<span class="nc" id="L249">                    Double stop = Double.parseDouble(values[1]);</span>
<span class="nc" id="L250">                    Double step = Double.parseDouble(values[2]);</span>
<span class="nc bnc" id="L251" title="All 2 branches missed.">                    for (double d = start; d &lt;= stop; d += step) {</span>
<span class="nc" id="L252">                        ps.addValue(d + &quot;&quot;);</span>
                    }

<span class="nc bnc" id="L255" title="All 2 branches missed.">                } else if (valuesStr.contains(ApplicationConstants.SEPARATOR_LIST)) {</span>

<span class="nc" id="L257">                    String[] values = valuesStr.split(ApplicationConstants.SEPARATOR_LIST);</span>
<span class="nc bnc" id="L258" title="All 2 branches missed.">                    for (String v : values) {</span>

<span class="nc" id="L260">                        String parsedParameter =</span>
<span class="nc" id="L261">                            parseParameter(user, groups, name, v);</span>
<span class="nc" id="L262">                        ps.addValue(parsedParameter);</span>
                    }
<span class="nc" id="L264">                } else {</span>
<span class="nc" id="L265">                    String parsedParameter =</span>
<span class="nc" id="L266">                        parseParameter(user, groups, name, valuesStr);</span>
<span class="nc" id="L267">                    ps.addValue(parsedParameter);</span>
                }
<span class="nc" id="L269">                parameters.add(ps);</span>
<span class="nc" id="L270">            }</span>

<span class="nc" id="L272">            AppVersion version = applicationDAO.getVersion(</span>
                    applicationName, applicationVersion);
<span class="nc" id="L274">            String workflowPath =</span>
<span class="nc" id="L275">                    dataManagerBusiness.getRemoteFile(user, version.getLfn());</span>

            //selectRandomEngine could also be used; TODO: make this choice configurable
<span class="nc" id="L278">            Engine engine = selectEngine(applicationClass);</span>
<span class="nc" id="L279">            WorkflowExecutionBusiness executionBusiness =</span>
<span class="nc" id="L280">                    getWorkflowExecutionBusiness(engine.getEndpoint());</span>
<span class="nc" id="L281">            Workflow workflow = null;</span>
            try {
<span class="nc" id="L283">                workflow = executionBusiness.launch(applicationName,</span>
                        applicationVersion, applicationClass, user, simulationName,
                        workflowPath, parameters);
<span class="nc" id="L286">            } catch (BusinessException be) {</span>
<span class="nc" id="L287">                logger.error(&quot;BusinessException caught on launch workflow, engine {} will be disabled&quot;, engine.getName());</span>
            } finally {
<span class="nc bnc" id="L289" title="All 2 branches missed.">                if (workflow == null) {</span>
<span class="nc" id="L290">                    engine.setStatus(&quot;disabled&quot;);</span>
<span class="nc" id="L291">                    this.engineBusiness.update(engine);</span>
<span class="nc bnc" id="L292" title="All 2 branches missed.">                    for (User u : usersGroupsDAO</span>
<span class="nc" id="L293">                            .getUsersFromGroup(CoreConstants.GROUP_SUPPORT)) {</span>
<span class="nc" id="L294">                        logger.info(&quot;Sending warning email to user &quot; + u.toString() + &quot; having email address &quot; + u.getEmail());</span>
<span class="nc" id="L295">                        emailBusiness.sendEmail(&quot;Urgent: VIP engine disabled&quot;,</span>
<span class="nc" id="L296">                                &quot;Engine &quot; + engine.getName() + &quot; has just been disabled. Please check that there is at least one active engine left.&quot;,</span>
<span class="nc" id="L297">                                new String[]{u.getEmail()}, true, user.getEmail());</span>
<span class="nc" id="L298">                    }</span>
<span class="nc" id="L299">                    throw new BusinessException(&quot;Workflow is null, engine &quot; + engine.getName() + &quot; has been disabled&quot;);</span>
                }else{
<span class="nc" id="L301">                    logger.info(&quot;Launched workflow &quot;+workflow.toString());</span>
                }
            }

<span class="nc" id="L305">            workflowDAO.add(workflow);</span>
<span class="nc" id="L306">            return workflow.getId();</span>

<span class="nc" id="L308">        } catch (WorkflowsDBDAOException ex) {</span>
<span class="nc" id="L309">            logger.error(&quot;Error launching simulation {}&quot;, simulationName, ex);</span>
<span class="nc" id="L310">            throw new BusinessException(ex);</span>
<span class="nc" id="L311">        } catch (DAOException | DataManagerException ex) {</span>
<span class="nc" id="L312">            throw new BusinessException(ex);</span>
        }
    }

    private String parseParameter(
            User user, List&lt;String&gt; groups, String parameterName, String parameterValue)
            throws DataManagerException, BusinessException {

<span class="nc" id="L320">        parameterValue = parameterValue.trim();</span>

<span class="nc" id="L322">        ExternalPlatformBusiness.ParseResult parseResult =</span>
<span class="nc" id="L323">            externalPlatformBusiness.parseParameter(</span>
                parameterName, parameterValue, user);
<span class="nc bnc" id="L325" title="All 2 branches missed.">        if (parseResult.isUri) {</span>
            // The uri has been generated
<span class="nc" id="L327">            return parseResult.result;</span>
        }
        // not an external platform parameter, use legacy format
<span class="nc" id="L330">        String parsedPath = lfcPathsBusiness.parseBaseDir(</span>
                user, parameterValue);
<span class="nc bnc" id="L332" title="All 2 branches missed.">        if (!user.isSystemAdministrator()) {</span>
<span class="nc" id="L333">            checkFolderACL(user, groups, parsedPath);</span>
        }
<span class="nc bnc" id="L335" title="All 2 branches missed.">        if ( ! parsedPath.equals(parameterValue) // the parameter is a file path</span>
<span class="nc bnc" id="L336" title="All 2 branches missed.">                &amp;&amp; server.useLocalFilesInInputs()) {</span>
<span class="nc" id="L337">            parsedPath = &quot;file:&quot; + parsedPath;</span>
        }
<span class="nc" id="L339">        return parsedPath;</span>
    }

    public List&lt;Simulation&gt; getSimulations(User user, Date lastDate)
            throws BusinessException {

        try {
<span class="nc bnc" id="L346" title="All 2 branches missed.">            return parseWorkflows(workflowDAO.get(user != null ? user.getFullName() : null, lastDate));</span>

<span class="nc" id="L348">        } catch (WorkflowsDBDAOException ex) {</span>
<span class="nc" id="L349">            logger.error(&quot;Error getting simulations for {} since {}&quot;, user, lastDate, ex);</span>
<span class="nc" id="L350">            throw new BusinessException(ex);</span>
        }
    }

    /**
     * Get the simulation information
     *
     */
    public List&lt;Simulation&gt; getSimulations(
            String userName, String application, String status, String appClass,
            Date startDate, Date endDate) throws BusinessException {

        try {
<span class="nc bnc" id="L363" title="All 2 branches missed.">            if (endDate != null) {</span>
<span class="nc" id="L364">                Calendar calendar = Calendar.getInstance();</span>
<span class="nc" id="L365">                calendar.setTime(endDate);</span>
<span class="nc" id="L366">                calendar.add(Calendar.DATE, 1);</span>
<span class="nc" id="L367">                endDate = calendar.getTime();</span>
            }

<span class="nc" id="L370">            WorkflowStatus wStatus = null;</span>
<span class="nc bnc" id="L371" title="All 2 branches missed.">            if (status != null) {</span>
<span class="nc" id="L372">                wStatus = WorkflowStatus.valueOf(status);</span>
            }

<span class="nc" id="L375">            List&lt;Simulation&gt; simulations = parseWorkflows(</span>
<span class="nc" id="L376">                    workflowDAO.get(</span>
                            userName, application, wStatus,
                            appClass, startDate, endDate));
<span class="nc" id="L379">            checkRunningSimulations(simulations);</span>

<span class="nc" id="L381">            return simulations;</span>

<span class="nc" id="L383">        } catch (WorkflowsDBDAOException ex) {</span>
<span class="nc" id="L384">            logger.error(&quot;Error searching simulations for {}&quot;, userName, ex);</span>
<span class="nc" id="L385">            throw new BusinessException(ex);</span>
        }
    }

    /**
     * Get the simulation information
     *
     * @param users list of users
     * @param status Simulation status to filter the request
     */
    public List&lt;Simulation&gt; getSimulations(
            List&lt;String&gt; users, String application, String status,
            String appClass, Date startDate, Date endDate)
            throws BusinessException {

        try {
<span class="nc bnc" id="L401" title="All 2 branches missed.">            if (endDate != null) {</span>
<span class="nc" id="L402">                Calendar calendar = Calendar.getInstance();</span>
<span class="nc" id="L403">                calendar.setTime(endDate);</span>
<span class="nc" id="L404">                calendar.add(Calendar.DATE, 1);</span>
<span class="nc" id="L405">                endDate = calendar.getTime();</span>
            }

<span class="nc" id="L408">            WorkflowStatus wStatus = null;</span>
<span class="nc bnc" id="L409" title="All 2 branches missed.">            if (status != null) {</span>
<span class="nc" id="L410">                wStatus = WorkflowStatus.valueOf(status);</span>
            }

<span class="nc" id="L413">            List&lt;Simulation&gt; simulations = parseWorkflows(</span>
<span class="nc" id="L414">                    workflowDAO.get(</span>
                            users, application, wStatus,
                            appClass, startDate, endDate));
<span class="nc" id="L417">            checkRunningSimulations(simulations);</span>

<span class="nc" id="L419">            return simulations;</span>

<span class="nc" id="L421">        } catch (WorkflowsDBDAOException ex) {</span>
<span class="nc" id="L422">            logger.error(&quot;Error searching simulations for users {}&quot;, users, ex);</span>
<span class="nc" id="L423">            throw new BusinessException(ex);</span>
        }
    }

    public Descriptor getApplicationDescriptor(
            User user, String applicationName, String applicationVersion)
            throws BusinessException {

        try {
<span class="nc" id="L432">            AppVersion version = applicationDAO.getVersion(applicationName, applicationVersion);</span>
<span class="nc" id="L433">            String workflowPath =</span>
<span class="nc" id="L434">                    dataManagerBusiness.getRemoteFile(user, version.getLfn());</span>
<span class="nc bnc" id="L435" title="All 2 branches missed.">            return workflowPath.endsWith(&quot;.gwendia&quot;)</span>
<span class="nc" id="L436">                    ? getGwendiaParser().parse(workflowPath)</span>
<span class="nc" id="L437">                    : getScuflParser().parse(workflowPath);</span>

<span class="nc" id="L439">        } catch (SAXException | IOException ex) {</span>
<span class="nc" id="L440">            logger.error(&quot;Error getting application descriptor for {}/{}&quot;,</span>
                    applicationName, applicationVersion, ex);
<span class="nc" id="L442">            throw new BusinessException(WRONG_APPLICATION_DESCRIPTOR, ex,</span>
                    applicationName + &quot;/&quot; + applicationVersion);
<span class="nc" id="L444">        } catch (DAOException | BusinessException ex) {</span>
<span class="nc" id="L445">            throw new BusinessException(WRONG_APPLICATION_DESCRIPTOR, ex,</span>
                    applicationName + &quot;/&quot; + applicationVersion);
        }
    }

    public void kill(String simulationID) throws BusinessException {

        try {
<span class="nc" id="L453">            Workflow workflow = workflowDAO.get(simulationID);</span>
<span class="nc" id="L454">            workflow.setStatus(WorkflowStatus.Killed);</span>
<span class="nc" id="L455">            workflowDAO.update(workflow);</span>
<span class="nc" id="L456">            WorkflowExecutionBusiness executionBusiness = getWorkflowExecutionBusiness(workflow.getEngine());</span>
<span class="nc" id="L457">            executionBusiness.kill(simulationID);</span>

<span class="nc" id="L459">        } catch (WorkflowsDBDAOException ex) {</span>
<span class="nc" id="L460">            logger.error(&quot;Error killing simulation {}&quot;, simulationID, ex);</span>
<span class="nc" id="L461">            throw new BusinessException(ex);</span>
<span class="nc" id="L462">        }</span>
<span class="nc" id="L463">    }</span>

    public void clean(String simulationID, String email, boolean deleteFiles)
            throws BusinessException {

        try {
<span class="nc" id="L469">            Workflow workflow = workflowDAO.get(simulationID);</span>
<span class="nc" id="L470">            workflow.setStatus(WorkflowStatus.Cleaned);</span>
<span class="nc" id="L471">            workflowDAO.update(workflow);</span>
<span class="nc bnc" id="L472" title="All 2 branches missed.">            if(deleteFiles){</span>
<span class="nc bnc" id="L473" title="All 2 branches missed.">                for (Output output : outputDAO.get(simulationID)) {</span>
<span class="nc" id="L474">                    gridaPoolClient.delete(output.getOutputID().getPath(), email);</span>
<span class="nc" id="L475">                }</span>
            }
<span class="nc" id="L477">            inputDAO.removeById(simulationID);</span>
<span class="nc" id="L478">            outputDAO.removeById(simulationID);</span>

<span class="nc" id="L480">        } catch (WorkflowsDBDAOException | GRIDAClientException ex) {</span>
<span class="nc" id="L481">            logger.error(&quot;Error cleaning simulation {}&quot;, simulationID, ex);</span>
<span class="nc" id="L482">            throw new BusinessException(ex);</span>
<span class="nc" id="L483">        }</span>
<span class="nc" id="L484">    }</span>

    public void clean(String simulationId, String email) throws BusinessException{
<span class="nc" id="L487">        clean(simulationId,email,true);</span>
<span class="nc" id="L488">    }</span>

    public void purge(String simulationID) throws BusinessException {

        try {
<span class="nc" id="L493">            workflowDAO.removeById(simulationID);</span>
<span class="nc" id="L494">            processorDAO.removeById(simulationID);</span>
<span class="nc" id="L495">            inputDAO.removeById(simulationID);</span>
<span class="nc" id="L496">            outputDAO.removeById(simulationID);</span>
<span class="nc" id="L497">            statsDAO.removeById(simulationID);</span>
<span class="nc" id="L498">            String workflowsPath = server.getWorkflowsPath();</span>
<span class="nc" id="L499">            File workflowDir = new File(workflowsPath, simulationID);</span>
<span class="nc" id="L500">            FileUtils.deleteQuietly(workflowDir);</span>

<span class="nc" id="L502">        } catch (WorkflowsDBDAOException ex) {</span>
<span class="nc" id="L503">            logger.error(&quot;Error purging simulation {}&quot;, simulationID, ex);</span>
<span class="nc" id="L504">            throw new BusinessException(ex);</span>
<span class="nc" id="L505">        }</span>
<span class="nc" id="L506">    }</span>

    public Map&lt;String, String&gt; relaunch(
            String simulationID, String currentUserFolder)
            throws BusinessException {

        //TODO fix
<span class="fc" id="L513">        Map&lt;String, String&gt; inputs =</span>
<span class="fc" id="L514">            getInputM2Parser(currentUserFolder).parse(</span>
<span class="fc" id="L515">                server.getWorkflowsPath() + &quot;/&quot; + simulationID + &quot;/input-m2.xml&quot;);</span>

<span class="fc" id="L517">        return inputs;</span>
    }

    public Simulation getSimulation(String simulationID) throws BusinessException {
<span class="nc" id="L521">        return getSimulation(simulationID, false);</span>
    }

    public Simulation getSimulation(String simulationID, boolean refresh)
            throws BusinessException {

<span class="nc" id="L527">        Simulation simulation = null;</span>
        try {
<span class="nc" id="L529">            Workflow workflow = workflowDAO.get(simulationID);</span>
<span class="nc bnc" id="L530" title="All 2 branches missed.">            if (workflow == null) {</span>
<span class="nc" id="L531">                logger.error(&quot;Cannot find execution with id {}&quot;, simulationID);</span>
<span class="nc" id="L532">                throw new BusinessException(&quot;Cannot find execution with id &quot; + simulationID);</span>
            }
<span class="nc" id="L534">            simulation = new Simulation(</span>
<span class="nc" id="L535">                    workflow.getApplication(),</span>
<span class="nc" id="L536">                    workflow.getApplicationVersion(),</span>
<span class="nc" id="L537">                    workflow.getApplicationClass(),</span>
<span class="nc" id="L538">                    workflow.getId(),</span>
<span class="nc" id="L539">                    workflow.getUsername(),</span>
<span class="nc" id="L540">                    workflow.getStartedTime(),</span>
<span class="nc" id="L541">                    workflow.getDescription(),</span>
<span class="nc" id="L542">                    workflow.getStatus().name(),</span>
<span class="nc" id="L543">                    workflow.getEngine());</span>
<span class="nc bnc" id="L544" title="All 2 branches missed.">            if (refresh) {</span>
<span class="nc" id="L545">                checkRunningSimulations(Collections.singletonList(simulation));</span>
            }

<span class="nc" id="L548">        } catch (WorkflowsDBDAOException ex) {</span>
<span class="nc" id="L549">            logger.error(&quot;Error getting simulation {}&quot;, simulationID, ex);</span>
<span class="nc" id="L550">            throw new BusinessException(ex);</span>
<span class="nc" id="L551">        }</span>

<span class="nc" id="L553">        return simulation;</span>
    }

    public List&lt;InOutData&gt; getOutputData(
            String simulationID, String currentUserFolder)
            throws BusinessException {

<span class="nc" id="L560">        List&lt;InOutData&gt; list = new ArrayList&lt;InOutData&gt;();</span>
        try {
<span class="nc bnc" id="L562" title="All 2 branches missed.">            for (Output output : outputDAO.get(simulationID)) {</span>
<span class="nc" id="L563">                String path = lfcPathsBusiness.parseRealDir(</span>
<span class="nc" id="L564">                    output.getOutputID().getPath(), currentUserFolder);</span>
<span class="nc" id="L565">                list.add(new InOutData(path, output.getOutputID().getProcessor(),</span>
<span class="nc" id="L566">                        output.getType().name()));</span>
<span class="nc" id="L567">            }</span>
<span class="nc" id="L568">        } catch (WorkflowsDBDAOException ex) {</span>
<span class="nc" id="L569">            logger.error(&quot;Error getting output data for {}&quot;, simulationID, ex);</span>
<span class="nc" id="L570">            throw new BusinessException(ex);</span>
<span class="nc" id="L571">        } catch (DataManagerException ex) {</span>
<span class="nc" id="L572">            throw new BusinessException(ex);</span>
<span class="nc" id="L573">        }</span>

<span class="nc" id="L575">        return list;</span>
    }

    public List&lt;InOutData&gt; getInputData(
            String simulationID, String currentUserFolder)
            throws BusinessException {

        try {
<span class="nc" id="L583">            List&lt;InOutData&gt; list = new ArrayList&lt;InOutData&gt;();</span>
<span class="nc bnc" id="L584" title="All 2 branches missed.">            for (Input input : inputDAO.get(simulationID)) {</span>
<span class="nc" id="L585">                String path = lfcPathsBusiness.parseRealDir(</span>
<span class="nc" id="L586">                    input.getInputID().getPath(), currentUserFolder);</span>
<span class="nc" id="L587">                list.add(new InOutData(path, input.getInputID().getProcessor(),</span>
<span class="nc" id="L588">                        input.getType().name()));</span>
<span class="nc" id="L589">            }</span>
<span class="nc" id="L590">            return list;</span>

<span class="nc" id="L592">        } catch (WorkflowsDBDAOException ex) {</span>
<span class="nc" id="L593">            logger.error(&quot;Error getting input data for {}&quot;, simulationID, ex);</span>
<span class="nc" id="L594">            throw new BusinessException(ex);</span>
<span class="nc" id="L595">        } catch (DataManagerException ex) {</span>
<span class="nc" id="L596">            throw new BusinessException(ex);</span>
        }
    }

    public void deleteLogData(String path) throws BusinessException {

        try {
<span class="nc" id="L603">            File file = new File(server.getWorkflowsPath(), path);</span>
<span class="nc bnc" id="L604" title="All 2 branches missed.">            if (file.isDirectory()) {</span>
<span class="nc" id="L605">                FileUtils.deleteDirectory(file);</span>

<span class="nc bnc" id="L607" title="All 2 branches missed.">            } else if (!file.delete()) {</span>
<span class="nc" id="L608">                logger.error(&quot;Unable to delete log : {}&quot;, path);</span>
<span class="nc" id="L609">                throw new BusinessException(&quot;Unable to delete data: &quot; + path);</span>
            }
<span class="nc" id="L611">        } catch (java.io.IOException ex) {</span>
<span class="nc" id="L612">            logger.error(&quot;Error deleting log data for {}&quot;, path, ex);</span>
<span class="nc" id="L613">            throw new BusinessException(ex);</span>
<span class="nc" id="L614">        }</span>
<span class="nc" id="L615">    }</span>

    public List&lt;Activity&gt; getProcessors(String simulationID) throws BusinessException {

        try {
<span class="nc" id="L620">            List&lt;Activity&gt; list = new ArrayList&lt;Activity&gt;();</span>
<span class="nc bnc" id="L621" title="All 2 branches missed.">            for (Processor processor : processorDAO.get(simulationID)) {</span>

<span class="nc" id="L623">                ProcessorStatus status = ProcessorStatus.Unstarted;</span>

<span class="nc bnc" id="L625" title="All 2 branches missed.">                if (processor.getCompleted() + processor.getQueued() + processor.getFailed() &gt; 0) {</span>
//                    if (failed &gt; 0) {
//                        status = ProcessorStatus.Failed;
//                    } else
<span class="nc bnc" id="L629" title="All 2 branches missed.">                    if (processor.getQueued() &gt; 0) {</span>
<span class="nc" id="L630">                        status = ProcessorStatus.Active;</span>
                    } else {
<span class="nc" id="L632">                        status = ProcessorStatus.Completed;</span>
                    }
                }
<span class="nc" id="L635">                list.add(new Activity(processor.getProcessorID().getProcessor(),</span>
<span class="nc" id="L636">                        status, processor.getCompleted(), processor.getQueued(),</span>
<span class="nc" id="L637">                        processor.getFailed()));</span>
<span class="nc" id="L638">            }</span>
<span class="nc" id="L639">            return list;</span>

<span class="nc" id="L641">        } catch (WorkflowsDBDAOException ex) {</span>
<span class="nc" id="L642">            logger.error(&quot;Error getting processors for {}&quot;, simulationID, ex);</span>
<span class="nc" id="L643">            throw new BusinessException(ex);</span>
        }
    }

    public List&lt;String&gt; getPerformanceStats(
            List&lt;Simulation&gt; simulationIDList, int type)
            throws BusinessException, WorkflowsDBDAOException {

<span class="nc" id="L651">        List&lt;String&gt; workflowIDList = new ArrayList&lt;String&gt;();</span>
<span class="nc" id="L652">        List&lt;String&gt; stats = new ArrayList&lt;String&gt;();</span>
<span class="nc bnc" id="L653" title="All 2 branches missed.">        if (simulationIDList != null) {</span>
<span class="nc bnc" id="L654" title="All 2 branches missed.">            for (int i = 0; i &lt; simulationIDList.size(); i++) {</span>
                //logger.error(&quot;Stat module, id is &quot;+simulationIDList.get(i).getID());
<span class="nc" id="L656">                workflowIDList.add(simulationIDList.get(i).getID());</span>
            }
        } else {
<span class="nc" id="L659">            logger.error(&quot;Incorrect call of getPerformanceStats : Execution list is null&quot;);</span>
<span class="nc" id="L660">            throw new BusinessException(&quot;Execution list is null!&quot;);</span>
        }

<span class="nc bnc" id="L663" title="All 4 branches missed.">        if (workflowIDList != null &amp;&amp; !workflowIDList.isEmpty()) {</span>
            try {
<span class="nc bnc" id="L665" title="All 5 branches missed.">                switch (type) {</span>
                    case 1:
<span class="nc" id="L667">                        stats = simulationStatsDAO.getBySimulationID(workflowIDList);</span>
<span class="nc" id="L668">                        break;</span>
                    case 2:
<span class="nc" id="L670">                        stats = simulationStatsDAO.getWorkflowsPerUser(workflowIDList);</span>
<span class="nc" id="L671">                        break;</span>
                    case 3:
<span class="nc" id="L673">                        stats = simulationStatsDAO.getApplications(workflowIDList);</span>
<span class="nc" id="L674">                        break;</span>
                    case 4:
<span class="nc" id="L676">                        stats = simulationStatsDAO.getClasses(workflowIDList);</span>

                }


<span class="nc" id="L681">            } catch (DAOException ex) {</span>
<span class="nc" id="L682">                throw new BusinessException(ex);</span>
<span class="nc" id="L683">            }</span>

        } else {
<span class="nc" id="L686">            logger.error(&quot;Internall error in getPerformanceStats : workflowIDList is null&quot;);</span>
<span class="nc" id="L687">            throw new BusinessException(&quot;Empty workflow list!&quot;);</span>
        }
<span class="nc" id="L689">        return stats;</span>
    }

    public void validateInputs(User user, List&lt;String&gt; inputs)
            throws BusinessException {

        try {

<span class="nc" id="L697">            StringBuilder sb = new StringBuilder();</span>
<span class="nc bnc" id="L698" title="All 2 branches missed.">            for (String input : inputs) {</span>
<span class="nc bnc" id="L699" title="All 2 branches missed.">                if (!gridaClient.exist(</span>
<span class="nc" id="L700">                        lfcPathsBusiness.parseBaseDir(user, input))) {</span>
<span class="nc bnc" id="L701" title="All 2 branches missed.">                    if (sb.length() &gt; 0) {</span>
<span class="nc" id="L702">                        sb.append(&quot;, &quot;);</span>
                    }

<span class="nc" id="L705">                    sb.append(</span>
<span class="nc" id="L706">                        lfcPathsBusiness.parseBaseDir(user, input));</span>
                }
<span class="nc" id="L708">            }</span>

<span class="nc bnc" id="L710" title="All 2 branches missed.">            if (sb.length() &gt; 0) {</span>
<span class="nc" id="L711">                logger.error(&quot;The following data does not exist: &quot; + sb.toString());</span>
<span class="nc" id="L712">                throw new fr.insalyon.creatis.vip.core.server.business.BusinessException(</span>
<span class="nc" id="L713">                        &quot;The following data does not exist: &quot; + sb.toString());</span>
            }
<span class="nc" id="L715">        } catch (DataManagerException ex) {</span>
<span class="nc" id="L716">            throw new BusinessException(ex);</span>
<span class="nc" id="L717">        } catch (GRIDAClientException ex) {</span>
<span class="nc" id="L718">            logger.error(&quot;Error validating inputs for {}&quot;, user, ex);</span>
<span class="nc" id="L719">            throw new BusinessException(ex);</span>
<span class="nc" id="L720">        }</span>
<span class="nc" id="L721">    }</span>

    public void updateUser(String currentUser, String newUser)
            throws BusinessException {

        try {
<span class="nc" id="L727">            workflowDAO.updateUsername(newUser, currentUser);</span>

<span class="nc" id="L729">        } catch (WorkflowsDBDAOException ex) {</span>
<span class="nc" id="L730">            logger.error(&quot;Error updating username from {} to {}&quot;, currentUser, newUser, ex);</span>
<span class="nc" id="L731">            throw new BusinessException(ex);</span>
<span class="nc" id="L732">        }</span>
<span class="nc" id="L733">    }</span>

    public void updateDescription(String simulationID, String newDescription)
            throws BusinessException {
        try {
<span class="nc" id="L738">            Workflow w= workflowDAO.get(simulationID);</span>
<span class="nc" id="L739">            w.setDescription(newDescription);</span>
<span class="nc" id="L740">            workflowDAO.update(w);</span>
<span class="nc" id="L741">        } catch (WorkflowsDBDAOException ex) {</span>
<span class="nc" id="L742">            logger.error(&quot;Error updating description for {} to {}&quot;, simulationID, newDescription, ex);</span>
<span class="nc" id="L743">            throw new BusinessException(ex);</span>
<span class="nc" id="L744">        }</span>
<span class="nc" id="L745">    }</span>

    public List&lt;Simulation&gt; getRunningSimulations() throws BusinessException {


        try {
<span class="nc" id="L751">            return parseWorkflows(workflowDAO.getRunning());</span>

<span class="nc" id="L753">        } catch (WorkflowsDBDAOException ex) {</span>
<span class="nc" id="L754">            logger.error(&quot;Error getting all running simulations&quot;, ex);</span>
<span class="nc" id="L755">            throw new BusinessException(ex);</span>
        }
    }

    private void checkFolderACL(User user, List&lt;String&gt; groups, String path)
            throws BusinessException {


<span class="nc bnc" id="L763" title="All 2 branches missed.">        if (path.startsWith(server.getDataManagerUsersHome())) {</span>

<span class="nc" id="L765">            path = path.replace(server.getDataManagerUsersHome() + &quot;/&quot;, &quot;&quot;);</span>
<span class="nc bnc" id="L766" title="All 2 branches missed.">            if (!path.startsWith(user.getFolder())) {</span>

<span class="nc" id="L768">                logger.error(&quot;User {} tried to access data from another user: {}&quot;, user, path);</span>
<span class="nc" id="L769">                throw new BusinessException(&quot;Access denied to another user's home.&quot;);</span>
            }
<span class="nc bnc" id="L771" title="All 2 branches missed.">        } else if (path.startsWith(server.getDataManagerGroupsHome())) {</span>

<span class="nc" id="L773">            path = path.replace(server.getDataManagerGroupsHome() + &quot;/&quot;, &quot;&quot;);</span>
<span class="nc bnc" id="L774" title="All 2 branches missed.">            if (path.indexOf(&quot;/&quot;) != -1) {</span>
<span class="nc" id="L775">                path = path.substring(0, path.indexOf(&quot;/&quot;));</span>
            }

<span class="nc bnc" id="L778" title="All 2 branches missed.">            if (!DataManagerUtil.getPaths(groups).contains(path)) {</span>
<span class="nc" id="L779">                logger.error(&quot;User {} tried to access data from a non-autorized group: {}&quot;, user, path);</span>
<span class="nc" id="L780">                throw new BusinessException(&quot;Access denied to group '&quot; + path + &quot;'.&quot;);</span>
            }
        }
<span class="nc" id="L783">    }</span>

    private List&lt;Simulation&gt; parseWorkflows(List&lt;Workflow&gt; list) {

<span class="nc" id="L787">        List&lt;Simulation&gt; simulationsList = new ArrayList&lt;Simulation&gt;();</span>
<span class="nc bnc" id="L788" title="All 2 branches missed.">        for (Workflow workflow : list) {</span>
<span class="nc" id="L789">            simulationsList.add(new Simulation(</span>
<span class="nc" id="L790">                    workflow.getApplication(),</span>
<span class="nc" id="L791">                    workflow.getApplicationVersion(),</span>
<span class="nc" id="L792">                    workflow.getApplicationClass(),</span>
<span class="nc" id="L793">                    workflow.getId(),</span>
<span class="nc" id="L794">                    workflow.getUsername(),</span>
<span class="nc" id="L795">                    workflow.getStartedTime(),</span>
<span class="nc" id="L796">                    workflow.getDescription(),</span>
<span class="nc" id="L797">                    workflow.getStatus().name(),</span>
<span class="nc" id="L798">                    workflow.getEngine()));</span>
<span class="nc" id="L799">        }</span>
<span class="nc" id="L800">        return simulationsList;</span>
    }

    private void checkRunningSimulations(List&lt;Simulation&gt; simulations)
            throws BusinessException, WorkflowsDBDAOException {

<span class="nc bnc" id="L806" title="All 2 branches missed.">        for (Simulation simulation : simulations) {</span>

<span class="nc bnc" id="L808" title="All 2 branches missed.">            if (simulation.getStatus() == SimulationStatus.Running</span>
<span class="nc bnc" id="L809" title="All 2 branches missed.">                    || simulation.getStatus() == SimulationStatus.Unknown) {</span>
<span class="nc" id="L810">                WorkflowExecutionBusiness executionBusiness = getWorkflowExecutionBusiness(simulation.getEngine());</span>
<span class="nc" id="L811">                SimulationStatus simulationStatus = executionBusiness.getStatus(simulation.getID());</span>

<span class="nc bnc" id="L813" title="All 4 branches missed.">                if (simulationStatus != SimulationStatus.Running</span>
                        &amp;&amp; simulationStatus != SimulationStatus.Unknown) {
<span class="nc" id="L815">                    simulation.setStatus(simulationStatus);</span>
<span class="nc" id="L816">                    Workflow workflow = workflowDAO.get(simulation.getID());</span>
<span class="nc" id="L817">                    workflow.setStatus(WorkflowStatus.valueOf(simulationStatus.name()));</span>
<span class="nc" id="L818">                    workflowDAO.update(workflow);</span>
                }
            }
<span class="nc" id="L821">        }</span>
<span class="nc" id="L822">    }</span>

    public void markCompleted(String simulationID) throws BusinessException {
        try {
<span class="nc" id="L826">            Workflow workflow = workflowDAO.get(simulationID);</span>
<span class="nc" id="L827">            workflow.setStatus(WorkflowStatus.Completed);</span>
<span class="nc" id="L828">            workflowDAO.update(workflow);</span>


<span class="nc" id="L831">        } catch (WorkflowsDBDAOException ex) {</span>
<span class="nc" id="L832">            logger.error(&quot;Error marking simulation {} completed&quot;, simulationID, ex);</span>
<span class="nc" id="L833">            throw new BusinessException(ex);</span>
<span class="nc" id="L834">        }</span>
<span class="nc" id="L835">    }</span>

    public void changeSimulationUser(String simulationId, String user)
            throws BusinessException {
        try {
<span class="nc" id="L840">            Workflow workflow = workflowDAO.get(simulationId);</span>
<span class="nc" id="L841">            workflow.setUsername(user);</span>
<span class="nc" id="L842">            workflowDAO.update(workflow);</span>


<span class="nc" id="L845">        } catch (WorkflowsDBDAOException ex) {</span>
<span class="nc" id="L846">            logger.error(&quot;Error changing simulation {} owner to {}&quot;, simulationId, user, ex);</span>
<span class="nc" id="L847">            throw new BusinessException(ex);</span>
<span class="nc" id="L848">        }</span>
<span class="nc" id="L849">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>